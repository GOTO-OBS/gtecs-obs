#!/usr/bin/env python3
"""Create a blank observing database."""

import argparse
import os
import sys

from gototile.grid import SkyGrid

from gtecs.common.database import create_database
from gtecs.obs import database as db
from gtecs.obs import params
from gtecs.obs.database.models import Base, SQL_CODE


def run(overwrite=False, add_defaults=False, verbose=False):
    """Create and fill the database."""
    # Create a blank database
    print(f'Creating blank {params.DATABASE_DIALECT} database...')
    try:
        create_database(
            Base,
            name='obs',
            description='Scheduler observing database',
            user=params.DATABASE_USER,
            password=params.DATABASE_PASSWORD,
            host=params.DATABASE_HOST,
            dialect=params.DATABASE_DIALECT,
            overwrite=overwrite,
            sql_code=SQL_CODE,
            verbose=verbose,
        )
    except ValueError as err:
        if 'already exists' in str(err):
            print('ERROR: Database already exists.')
            print('       Rerun with -o/--overwrite to drop existing data.')
            sys.exit()
        else:
            raise

    if add_defaults:
        # Create the default user (NB no password)
        print('Creating default user...')
        user = db.User('default', '', 'Default user')
        with db.open_session() as session:
            session.add(user)

        # Add in default GOTO sites and telescopes
        print('Creating entires for GOTO telescopes...')
        site1 = db.Site.from_name('LaPalma')
        site2 = db.Site.from_name('SSO')

        skygrid = SkyGrid.from_name('GOTO-8')
        grid = db.Grid.from_skygrid(skygrid, name='GOTO-8_grid')
        for coord, name in zip(skygrid.coords, skygrid.tilenames):
            ra = coord.ra.value
            dec = coord.dec.value
            if abs(dec) < 0.00001:  # GOTO-tile rounding errors
                dec = 0
            grid_tile = db.GridTile(name=str(name),
                                    ra=float(ra),
                                    dec=float(dec),
                                    grid=grid)
            grid.grid_tiles.append(grid_tile)

        # Create default horizon files for each telescope
        horizons = []
        for telescope_id in [1, 2, 3, 4]:
            horizon_paths = []
            for filename in ['horizon', 'horizon_shielding']:
                if not os.path.exists(params.FILE_PATH):
                    os.mkdir(params.FILE_PATH)
                horizon_file = os.path.join(params.FILE_PATH, filename + f'_{telescope_id}')
                if not os.path.exists(horizon_file):
                    # Write a default file
                    with open(horizon_file, 'w') as f:
                        f.write('# The artificial horizon used by the scheduler\n')
                        for az in range(0, 361, 30):
                            f.write(f'{az}\t30\tDome\n')
                else:
                    print(f'  Horizon file {horizon_file} already exists')
                horizon_paths.append((horizon_file))
            horizons.append(';'.join(horizon_paths))

        # Create the telescopes
        goto1 = db.Telescope(name='GOTO-1', horizon=horizons[0], site=site1, grid=grid)
        goto2 = db.Telescope(name='GOTO-2', horizon=horizons[1], site=site1, grid=grid)
        goto3 = db.Telescope(name='GOTO-3', horizon=horizons[2], site=site2, grid=grid)
        goto4 = db.Telescope(name='GOTO-4', horizon=horizons[3], site=site2, grid=grid)

        # We need to be specific about the order for the IDs to be correct...
        for tel in [goto1, goto2, goto3, goto4]:
            session.add(tel)
            session.commit()

    print('Done')


if __name__ == '__main__':
    description = """Create the scheduler observing database."""

    parser = argparse.ArgumentParser(description=description,
                                     formatter_class=argparse.ArgumentDefaultsHelpFormatter)

    parser.add_argument('-v', '--verbose', action='store_true', default=False,
                        help='Print SQL statements?')
    parser.add_argument('-o', '--overwrite', action='store_true', default=False,
                        help='Overwrite an existing database [WARNING: WILL LOSE DATA]?')
    parser.add_argument('-d', '--add-defaults', action='store_true', default=False,
                        help='Add default (GOTO) telescope definitions?')

    args = parser.parse_args()

    run(args.overwrite, args.add_defaults, args.verbose)
